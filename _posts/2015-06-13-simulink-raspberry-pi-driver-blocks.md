---
id: 728
title: Simulink Raspberry Pi Driver Blocks
date: 2015-06-13T10:02:18+01:00
author: John
layout: post
guid: http://engineer.john-whittington.co.uk/?p=728
permalink: /2015/06/simulink-raspberry-pi-driver-blocks/
image: assets/img/uploads/2015/06/blocks-730x510.png
categories:
  - Programming
tags:
  - guide
  - MATLAB
  - simulink
---
Following on from [adding support to wiringPi for the MCP4725 DAC](http://engineer.john-whittington.co.uk/2015/03/raspberry-pi-dac-mcp4725-with-wiringpi/), I wanted to add driver blocks to Simulink such that one could use them to create graphical models for the Raspberry Pi that could interface with the real-world &#8211; a workable alternative to expensive real-time targets.

<!--more-->

Using the S-Function Builder and some other [user created blocks](http://www.mathworks.com/matlabcentral/fileexchange/41491-raspberry-pi-driver-block-sfunction) (which didn&#8217;t work &#8211; see below) as a basis, the process isn&#8217;t too difficult thanks to the generic function prototypes wiringPi uses. All the low-level stuff is done in the library as explained in my previous post, the S-Function just has to call `mcp4725Setup()` at first step, followed by `analogWrite()` at each proceeding step. See the screenshots below.

<div id='gallery-16' class='gallery galleryid-728 gallery-columns-3 gallery-size-thumbnail'>
  <figure class='gallery-item'> 
  
  <div class='gallery-icon landscape'>
    <a href='http://localhost/2015/06/simulink-raspberry-pi-driver-blocks/capture-5/'><img width="150" height="150" src="/assets/img/uploads/2015/06/Capture-150x150.png" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" aria-describedby="gallery-16-729" /></a>
  </div><figcaption class='wp-caption-text gallery-caption' id='gallery-16-729'> Setup runs on first step using the xD flag </figcaption></figure><figure class='gallery-item'> 
  
  <div class='gallery-icon landscape'>
    <a href='http://localhost/2015/06/simulink-raspberry-pi-driver-blocks/capture2-2/'><img width="150" height="150" src="/assets/img/uploads/2015/06/Capture2-150x150.png" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" aria-describedby="gallery-16-730" /></a>
  </div><figcaption class='wp-caption-text gallery-caption' id='gallery-16-730'> analogWrite is called to write the block input data to the DAC </figcaption></figure><figure class='gallery-item'> 
  
  <div class='gallery-icon landscape'>
    <a href='http://localhost/2015/06/simulink-raspberry-pi-driver-blocks/capture3/'><img width="150" height="150" src="/assets/img/uploads/2015/06/Capture3-150x150.png" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" aria-describedby="gallery-16-731" /></a>
  </div><figcaption class='wp-caption-text gallery-caption' id='gallery-16-731'> Includes are added to the generated code by the .tlc generated by the S-Function. Paths don&#8217;t have to explicit because wiringPi is installed to the standard includes folder </figcaption></figure>
</div>

&#8216;Build&#8217; creates the target language compile (.tlc) and .c code for the blocks such that Simulink Embedded Coder can incorporate them into the generated code. The process of generating, deploying to the Raspberry Pi and compiling over SSH is all very slick! Slick until compilation stops due to undefined references. The undefineds are the standard wiringPi functions &#8211; the Simulink makefile does not include the wiringPi library by default, even though the MATLAB Raspbian image has wiringPi installed. The error occurs with the older example blocks too so it looks like something changed at some point down the line.

## Remote Build Makefile Setup

After a long time digging around in the remote build templates I finally found an undocumented command to get it working: `xmakefilesetup`. Run this in the MATLAB command window with the Raspberry Pi model open. The settings should be as below. Navigate to Linker > Arguments and add &#8216;lwiringPi&#8217; on the end (this tells the linker to use the wiringPi library and so the wiringPi functions will be linked). If you&#8217;re using my ADC/DAC blocks with ADS1115 and MCP4725, you&#8217;ll also have to update the wiringPi library with [my library](https://github.com/tuna-f1sh/wiringPi-mcp4725) by logging on via SSH and following [these steps](https://github.com/tuna-f1sh/wiringPi-mcp4725/blob/master/INSTALL).<figure id="attachment_734" aria-describedby="caption-attachment-734" style="width: 716px" class="wp-caption aligncenter">

[<img loading="lazy" class="wp-image-734 size-full" src="http://engineer.john-whittington.co.ukassets/img/uploads/2015/06/xmakefilesetup.png" alt="Add '-lwiringPi' to the linker 'Arguments' command string." width="716" height="435" srcset="/assets/img/uploads/2015/06/xmakefilesetup.png 716w, /assets/img/uploads/2015/06/xmakefilesetup-300x182.png 300w" sizes="(max-width: 716px) 100vw, 716px" />](http://engineer.john-whittington.co.ukassets/img/uploads/2015/06/xmakefilesetup.png)<figcaption id="caption-attachment-734" class="wp-caption-text">Add &#8216;-lwiringPi&#8217; to the linker &#8216;Arguments&#8217; command string. This will affect upon all Linux remote build models.</figcaption></figure> 

I created a model with four driver blocks with example usage that can be copied and pasted into other models &#8211; remember to &#8216;Build&#8217; the s-functions in the model directories and install my version of wiringPi. It can be downloaded below.

[rpi-driver-blocks](http://engineer.john-whittington.co.ukassets/img/uploads/2015/06/rpi-driver-blocks.zip)